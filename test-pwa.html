<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #181C21;
            color: white;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #1E232A;
            border: 1px solid #333;
        }
        .status.success { border-color: #4CAF50; }
        .status.error { border-color: #f44336; }
        .status.warning { border-color: #ff9800; }
        .status.info { border-color: #2196F3; }
        button {
            background: #00E4FF;
            color: #0B4F6C;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { opacity: 0.9; }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        pre {
            background: #0f1419;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” EchoListen PWA çŠ¶æ€æ£€æµ‹</h1>

    <div id="results"></div>

    <h2>ğŸ“‹ æ£€æµ‹æ­¥éª¤</h2>
    <div class="status info">
        <strong>æ­¥éª¤ 1ï¼š</strong> æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆæŒ‰ F12ï¼‰
    </div>
    <div class="status info">
        <strong>æ­¥éª¤ 2ï¼š</strong> æŸ¥çœ‹ä¸‹æ–¹çš„æ£€æµ‹ç»“æœ
    </div>
    <div class="status info">
        <strong>æ­¥éª¤ 3ï¼š</strong> å¦‚æœæ˜¾ç¤º"å¯ä»¥å®‰è£…"ï¼Œç‚¹å‡»å®‰è£…æŒ‰é’®
    </div>

    <script>
        const results = document.getElementById('results');
        let deferredPrompt = null;

        function addResult(type, title, message) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${message}`;
            results.appendChild(div);
        }

        function addCode(code) {
            const pre = document.createElement('pre');
            pre.textContent = code;
            results.appendChild(pre);
        }

        // æ£€æŸ¥ 1: æµè§ˆå™¨æ”¯æŒ
        addResult('info', 'ğŸŒ æµè§ˆå™¨æ”¯æŒæ£€æŸ¥',
            `Service Worker: ${navigator.serviceWorker ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}<br>` +
            `PWA Manifest: ${linkTypesSupported ? 'âœ… æ”¯æŒ' : 'âš ï¸ å¯èƒ½ä¸æ”¯æŒ'}`
        );

        // æ£€æŸ¥ 2: æ˜¯å¦åœ¨ç‹¬ç«‹çª—å£ï¼ˆå·²å®‰è£…ï¼‰
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                           window.matchMedia('(display-mode: minimal-ui)').matches;

        addResult(
            isStandalone ? 'success' : 'info',
            'ğŸ“± å®‰è£…çŠ¶æ€',
            isStandalone ? 'âœ… åº”ç”¨å·²å®‰è£…ï¼ˆç‹¬ç«‹çª—å£è¿è¡Œï¼‰' : 'âš ï¸ åº”ç”¨æœªå®‰è£…ï¼ˆæµè§ˆå™¨ä¸­è¿è¡Œï¼‰'
        );

        // æ£€æŸ¥ 3: HTTPS
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        addResult(
            isSecure ? 'success' : 'error',
            'ğŸ”’ å®‰å…¨è¿æ¥',
            isSecure ? 'âœ… ä½¿ç”¨ HTTPS æˆ– localhost' : 'âŒ PWA éœ€è¦ HTTPSï¼ˆlocalhost é™¤å¤–ï¼‰'
        );

        // æ£€æŸ¥ 4: ç›‘å¬ beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            addResult('success', 'ğŸ‰ PWA å¯ä»¥å®‰è£…ï¼',
                'æµè§ˆå™¨æ£€æµ‹åˆ° PWAï¼Œå¯ä»¥å®‰è£…äº†ï¼<br>' +
                'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è§¦å‘å®‰è£…æç¤ºã€‚'
            );

            // æ·»åŠ å®‰è£…æŒ‰é’®
            const installBtn = document.createElement('button');
            installBtn.textContent = 'ğŸ“¥ å®‰è£…åº”ç”¨';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    addResult(
                        outcome === 'accepted' ? 'success' : 'warning',
                        outcome === 'accepted' ? 'âœ… å®‰è£…æˆåŠŸ' : 'âš ï¸ å®‰è£…å–æ¶ˆ',
                        `ç”¨æˆ·é€‰æ‹©ï¼š${outcome}`
                    );
                    deferredPrompt = null;
                    installBtn.remove();
                }
            };
            results.appendChild(installBtn);
        });

        // æ£€æŸ¥ 5: ç›‘å¬å®‰è£…å®Œæˆ
        window.addEventListener('appinstalled', () => {
            addResult('success', 'âœ… åº”ç”¨å·²å®‰è£…',
                'PWA å®‰è£…å®Œæˆï¼<br>ç°åœ¨å¯ä»¥ä»æ¡Œé¢æˆ–åº”ç”¨åˆ—è¡¨å¯åŠ¨ã€‚'
            );
        });

        // æ£€æŸ¥ 6: Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    addResult('success', 'âš™ï¸ Service Worker',
                        `âœ… Service Worker å·²æ³¨å†Œ<br>çŠ¶æ€: ${reg.active ? 'å·²æ¿€æ´»' : 'ç­‰å¾…æ¿€æ´»'}`
                    );

                    // æ£€æŸ¥æ›´æ–°
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            addResult('info', 'ğŸ”„ Service Worker æ›´æ–°',
                                `æ–°ç‰ˆæœ¬çŠ¶æ€: ${newWorker.state}`
                            );
                        });
                    });
                })
                .catch(err => {
                    addResult('error', 'âŒ Service Worker æ³¨å†Œå¤±è´¥',
                        `é”™è¯¯: ${err.message}`
                    );
                });
        }

        // æ£€æŸ¥ 7: Manifest
        fetch('./manifest.json')
            .then(r => r.json())
            .then(manifest => {
                addResult('success', 'ğŸ“„ Manifest.json',
                    `âœ… Manifest åŠ è½½æˆåŠŸ<br>` +
                    `åç§°: ${manifest.name}<br>` +
                    `çŸ­åç§°: ${manifest.short_name}<br>` +
                    `å›¾æ ‡æ•°é‡: ${manifest.icons ? manifest.icons.length : 0}`
                );
                addCode(JSON.stringify(manifest, null, 2));
            })
            .catch(err => {
                addResult('error', 'âŒ Manifest.json åŠ è½½å¤±è´¥',
                    `é”™è¯¯: ${err.message}`
                );
            });

        // æ£€æŸ¥ 8: ç»™ç”¨æˆ·çš„æ‰‹åŠ¨æç¤º
        setTimeout(() => {
            if (!deferredPrompt && !isStandalone) {
                addResult('warning', 'ğŸ’¡ æç¤º',
                    `PWA å®‰è£…äº‹ä»¶æœªè§¦å‘ã€‚<br><br>` +
                    `åŸå› å¯èƒ½æ˜¯ï¼š<br>` +
                    `1. åº”ç”¨å·²ç»å®‰è£…è¿‡äº†<br>` +
                    `2. æµè§ˆå™¨ä¸æ”¯æŒè¯¥åŠŸèƒ½<br>` +
                    `3. éœ€è¦æ‰‹åŠ¨é€šè¿‡æµè§ˆå™¨èœå•å®‰è£…<br><br>` +
                    `æ‰‹åŠ¨å®‰è£…æ–¹æ³•ï¼š<br>` +
                    `- Chrome: åœ°å€æ ç‚¹å‡» â‹® â†’ å®‰è£…åº”ç”¨<br>` +
                    `- Edge: è®¾ç½® â†’ åº”ç”¨ â†’ å®‰è£…åº”ç”¨<br>` +
                    `- æˆ–æŒ‰ Ctrl+Shift+A æ‰“å¼€åº”ç”¨åˆ—è¡¨`
                );
            }
        }, 2000);

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ£€æµ‹åˆ°é“¾æ¥ç±»å‹æ”¯æŒ
        let linkTypesSupported = false;
        try {
            const link = document.createElement('link');
            link.rel = 'manifest';
            linkTypesSupported = true;
        } catch (e) {
            linkTypesSupported = false;
        }
    </script>
</body>
</html>
